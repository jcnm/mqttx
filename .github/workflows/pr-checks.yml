name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Analyze PR changes
        id: analyze
        run: |
          echo "## üìä Pull Request Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count files changed
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "**Files Changed:** $FILES_CHANGED" >> $GITHUB_STEP_SUMMARY

          # Count lines changed
          LINES_ADDED=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$1} END {print sum}')
          LINES_DELETED=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$2} END {print sum}')
          echo "**Lines Added:** +$LINES_ADDED" >> $GITHUB_STEP_SUMMARY
          echo "**Lines Deleted:** -$LINES_DELETED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Detect package changes
          echo "### üì¶ Packages Affected" >> $GITHUB_STEP_SUMMARY
          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep "^packages/" | cut -d'/' -f2 | sort -u | while read pkg; do
            echo "- \`@sparkplug/$pkg\`" >> $GITHUB_STEP_SUMMARY
          done

      - name: Check PR size
        run: |
          FILES=${{ steps.analyze.outputs.files_changed }}
          if [ "$FILES" -gt 50 ]; then
            echo "‚ö†Ô∏è **Large PR Warning:** This PR changes $FILES files. Consider breaking it into smaller PRs." >> $GITHUB_STEP_SUMMARY
          fi

  check-tests:
    name: Verify Tests for Changed Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check for test coverage
        run: |
          echo "## üß™ Test Coverage Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find changed source files
          CHANGED_SRC=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.ts$|\.tsx$' | grep -v test | grep -v '.d.ts' || true)

          if [ -n "$CHANGED_SRC" ]; then
            echo "**Changed Source Files:**" >> $GITHUB_STEP_SUMMARY
            echo "$CHANGED_SRC" | while read file; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY

              # Check if corresponding test file exists
              TEST_FILE=$(echo "$file" | sed 's/\.tsx\?$/.test.ts/' | sed 's/src\//tests\//')
              if [ -f "$TEST_FILE" ]; then
                echo "  ‚úÖ Has test file" >> $GITHUB_STEP_SUMMARY
              else
                echo "  ‚ö†Ô∏è **Missing test file**" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "No source files changed" >> $GITHUB_STEP_SUMMARY
          fi

  check-dependencies:
    name: Dependency Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check package.json changes
        run: |
          echo "## üì¶ Dependency Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PKG_CHANGES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep package.json || true)

          if [ -n "$PKG_CHANGES" ]; then
            echo "**Modified package.json files:**" >> $GITHUB_STEP_SUMMARY
            echo "$PKG_CHANGES" | while read file; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Review dependency changes carefully for security and compatibility**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ No dependency changes" >> $GITHUB_STEP_SUMMARY
          fi

  check-breaking-changes:
    name: Breaking Changes Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Scan for breaking changes
        run: |
          echo "## ‚ö†Ô∏è Breaking Changes Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check commit messages for breaking change markers
          BREAKING=$(git log --pretty=format:"%s" origin/${{ github.base_ref }}...HEAD | grep -i "BREAKING" || true)

          if [ -n "$BREAKING" ]; then
            echo "**Potential breaking changes detected in commits:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$BREAKING" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **Please update CHANGELOG and version numbers accordingly**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ No breaking changes detected" >> $GITHUB_STEP_SUMMARY
          fi

  pr-comment:
    name: Post PR Comment
    runs-on: ubuntu-latest
    needs: [pr-info, check-tests, check-dependencies, check-breaking-changes]
    if: always()

    steps:
      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `
            ## ü§ñ Automated PR Review

            Thank you for your contribution! Here's a quick automated review:

            ### ‚úÖ Checks Passed
            - CI pipeline triggered successfully
            - All required workflows have been executed

            ### üìù Next Steps
            1. Wait for all CI checks to complete
            2. Address any failing tests or lint errors
            3. Request review from maintainers
            4. Ensure all PR requirements are met

            ### üîç Review Checklist
            - [ ] All tests pass
            - [ ] No linting errors
            - [ ] Code follows project conventions
            - [ ] Documentation updated if needed
            - [ ] CHANGELOG updated for user-facing changes

            ---
            *This comment was generated automatically by the PR Checks workflow*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
